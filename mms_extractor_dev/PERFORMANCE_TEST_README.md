# MMS 추출기 API 성능 테스트

이 테스트는 MMS 추출기 API가 매번 호출 시마다 무거운 작업(임베딩 생성 등)을 반복하는지 확인하기 위한 도구입니다.

## 🎯 테스트 목적

- **임베딩 재생성 확인**: 매번 API 호출 시 `clue_embeddings` 생성이 실행되는지 확인
- **LLM 재초기화 확인**: 동일한 LLM 모델 사용 시 불필요한 재초기화가 발생하는지 확인
- **응답 시간 분석**: 첫 번째 요청 대비 후속 요청의 성능 개선 여부 확인

## 🚀 실행 방법

### 방법 1: 자동 실행 스크립트 (권장)
```bash
cd mms_extractor_unified
./run_performance_test.sh
```

### 방법 2: 수동 실행
```bash
# 1. API 서버 시작 (별도 터미널)
cd mms_extractor_unified
python api.py --host 0.0.0.0 --port 8080

# 2. 성능 테스트 실행 (다른 터미널)
cd mms_extractor_unified
python test_api_performance.py
```

## 📊 테스트 내용

### 1. 동일 설정 연속 요청 테스트
- 같은 LLM 모델과 설정으로 5번 연속 요청
- **기대 결과**: 두 번째 요청부터는 빨라져야 함 (캐싱 효과)
- **문제 징후**: 모든 요청이 비슷하게 오래 걸림 (매번 재초기화)

### 2. LLM 모델 변경 테스트
- 다른 LLM 모델(gemma, gpt, claude)로 각각 요청
- **기대 결과**: 모델 변경 시에만 초기화 시간 발생
- **문제 징후**: 모든 요청에서 긴 초기화 시간 발생

## 🔍 결과 해석

### ✅ 정상적인 경우
```
첫 번째 요청 시간: 15.234초
후속 요청 평균 시간: 3.456초
✅ 좋음: 후속 요청이 빨라짐 (캐싱 효과 있음)
```

### ⚠️ 문제가 있는 경우
```
첫 번째 요청 시간: 15.234초
후속 요청 평균 시간: 14.567초
⚠️ 경고: 후속 요청이 느려짐 (매번 재초기화 의심)
```

## 🔧 문제 해결

### 임베딩이 매번 생성되는 경우
1. **로그 확인**: 서버 로그에서 `🔄 프로그램 분류 임베딩 생성 시작...` 메시지가 매번 나타나는지 확인
2. **원인**: `clue_embeddings` 생성이 `process_message()` 메서드 내부에서 실행됨
3. **해결**: 임베딩 생성을 `_load_data()` 메서드로 이동

### LLM이 매번 재초기화되는 경우
1. **로그 확인**: `LLM 모델이 gemma -> gemma로 변경됨. 재초기화 중...` 같은 불필요한 로그
2. **원인**: `get_configured_extractor()`에서 모델 변경 여부를 확인하지 않음
3. **해결**: 이미 수정됨 (현재 코드는 모델이 실제로 변경될 때만 재초기화)

## 📋 로그 모니터링

테스트 중 서버 로그를 실시간으로 확인하려면:

```bash
# 서버 로그 실시간 확인
tail -f api_server.log

# 또는 서버를 포그라운드로 실행
python api.py --host 0.0.0.0 --port 8080 --debug
```

### 주요 로그 메시지

- `🔄 프로그램 분류 임베딩 생성 시작...` - 임베딩 생성 시작 (초기화 시에만 나타나야 함)
- `✅ 프로그램 분류 임베딩 생성 완료!` - 임베딩 생성 완료
- `LLM 모델이 X -> Y로 변경됨. 재초기화 중...` - LLM 재초기화 (모델 변경 시에만)
- `Batches: 100%|██████| 1/1 [00:00<00:00, X.XXit/s]` - 임베딩 생성 진행률

## 🐛 문제 발생 시

1. **API 서버 로그 확인**
2. **테스트 결과의 시간 패턴 분석**
3. **필요시 코드 수정 후 재테스트**

## 📝 테스트 결과 예시

```
============================================================
MMS 추출기 API 성능 테스트
============================================================

1. 서버 상태 확인 중...
✅ 서버가 시작되었습니다!

2. 동일한 설정으로 연속 요청 테스트 (캐싱 효과 확인)
   요청 1/5 진행 중... ✅ 12.345초 (서버: 12.123초)
   요청 2/5 진행 중... ✅ 3.456초 (서버: 3.234초)
   요청 3/5 진행 중... ✅ 3.567초 (서버: 3.345초)
   요청 4/5 진행 중... ✅ 3.234초 (서버: 3.012초)
   요청 5/5 진행 중... ✅ 3.678초 (서버: 3.456초)

4. 결과 분석
============================================================
첫 번째 요청 시간: 12.345초
후속 요청 평균 시간: 3.484초
✅ 좋음: 후속 요청이 빨라짐 (캐싱 효과 있음)
``` 