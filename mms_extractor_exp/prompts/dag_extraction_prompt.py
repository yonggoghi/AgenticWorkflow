"""
DAG (Directed Acyclic Graph) 추출 프롬프트 템플릿
엔티티 간의 관계를 방향성 있는 그래프로 추출하는 프롬프트
"""

# 메인 DAG 추출 프롬프트 템플릿
DAG_EXTRACTION_PROMPT_TEMPLATE = """
## 작업 목표
통신사 광고 메시지에서 **핵심 행동 흐름**을 추출하여 간결한 DAG(Directed Acyclic Graph) 형식으로 표현

## 핵심 원칙
1. **최소 경로 원칙**: 동일한 결과를 얻는 가장 짧은 경로만 표현
2. **핵심 흐름 우선**: 부가적 설명보다 주요 행동 연쇄에 집중
3. **중복 제거**: 의미가 겹치는 노드는 하나로 통합

## 출력 형식
```
(개체명:기대행동) -[관계동사]-> (개체명:기대행동)
또는
(개체명:기대행동)
```

## 개체명 카테고리
### 필수 추출 대상
- **제품/서비스**: 구체적 제품명, 서비스명, 요금제명
- **핵심 혜택**: 금전적 혜택, 사은품, 할인
- **행동 장소**: 온/오프라인 채널 (필요 시만)

### 추출 제외 대상
- 광고 대상자 (예: "아이폰 고객님")
- 일정/기간 정보
- 부가 설명 기능 (핵심 흐름과 무관한 경우)
- 법적 고지사항

## 기대 행동 (10개 표준 동사)
`구매, 가입, 사용, 방문, 참여, 등록, 다운로드, 확인, 수령, 적립`

## 관계 동사 우선순위
### 1순위: 조건부 관계
- `가입하면`, `구매하면`, `사용하면`, `신청하면`, `참여하면` ,`다운로드하면`, `전화하면`, '확인하면', '수령하면'
- `가입후`, `구매후`, `사용후`, `신청후`, `참여후` ,`다운로드후`, `전화후`, `확인후`, '수령후'

### 2순위: 결과 관계
- `받다`, `수령하다`, `적립하다`, `충전하다`, `적립하다`, `이용하다`, `사용하다`, `신청하다`, `등록하다`, `다운로드하다`, `확인하다`, `수령하다`

### 3순위: 경로 관계 (필요 시만)
- `통해`, `이용하여`, `사용하여`, `전화하여`, `방문하여`, `참여하여`, `등록하여`, `다운로드하여`, `확인하여`, `수령하여`

## DAG 구성 전략
### Step 1: 모든 가치 제안 식별
광고에서 제시하는 **모든 독립적 가치**를 파악
- **즉각적 혜택**: 금전적 보상, 사은품 등
- **서비스 가치**: 제품/서비스 자체의 기능과 혜택
예: "네이버페이 5000원" + "AI 통화 기능 무료 이용"

### Step 2: 독립 경로 구성
각 가치 제안별로 별도 경로 생성:
1. **혜택 획득 경로**: 가입 → 사용 → 보상
2. **서비스 체험 경로**: 가입 → 경험 → 기능 활용

### Step 3: 세부 기능 표현
주요 기능들이 명시된 경우 분기 구조로 표현:
- 통합 가능한 기능은 하나로 (예: AI통화녹음/요약 → "AI통화기능")
- 독립적 기능은 별도로 (예: AI스팸필터링)

## 분석 프로세스 (필수 단계)
### Step 1: 메시지 이해
- 전체 메시지를 한 문단으로 요약
- 광고주의 의도 파악
- **암시된 행동 식별**: 명시되지 않았지만 필수적인 행동 (예: 매장 방문)

### Step 2: 가치 제안 식별
- 즉각적 혜택 (금전, 사은품 등)
- 서비스 가치 (기능, 편의성 등)
- 부가 혜택 (있다면)

### Step 3: Root Node 결정
- **사용자의 첫 번째 행동은 무엇인가?**
- 매장 주소/연락처가 있다면 → 방문이 시작점
- 온라인 링크가 있다면 → 접속이 시작점
- 앱 관련 내용이라면 → 다운로드가 시작점

### Step 4: 관계 분석
- Root Node부터 시작하는 전체 흐름
- 각 행동 간 인과관계 검증
- 조건부 관계 명확화
- 시간적 순서 확인

### Step 5: DAG 구성
- 위 분석을 바탕으로 노드와 엣지 결정
- 중복 제거 및 통합

### Step 6: 자기 검증 및 수정
- **평가**: 초기 DAG를 아래 기준에 따라 검토
  - Root Node가 명확히 식별되었는가? (방문/접속/다운로드 등)
  - 모든 독립적 가치 제안이 포함되었는가? (즉각적 혜택과 서비스 가치)
  - 주요 기능들이 적절히 그룹화되었는가? (중복 제거 여부)
  - 각 경로가 명확한 가치를 전달하는가?
  - 전체 구조가 간결하고 이해하기 쉬운가?
  - 관계 동사가 우선순위에 맞게 사용되었는가? (조건부 > 결과 > 경로)
- **문제 식별**: 위 기준 중 충족되지 않은 항목을 명시하고, 그 이유를 설명
- **수정**: 식별된 문제를 해결한 수정된 DAG를 생성

### Step 7: 최종 검증
- 수정된 DAG가 모든 기준을 충족하는지 재확인
- 만약 문제가 남아있다면, 추가 수정 수행 (최대 2회 반복)
- 최종적으로 모든 기준이 충족되었음을 확인

## 출력 형식 (반드시 모든 섹션 포함)
### 1. 메시지 분석
```
[메시지 요약 및 핵심 의도]
[식별된 가치 제안 목록]
```

### 2. 초기 DAG
```
[초기 DAG 구조]
```

### 3. 자기 검증 결과
```
[평가 기준별 검토 결과]
[식별된 문제점 및 이유]
```

### 4. 수정된 DAG
```
[수정된 DAG 구조]
```

### 5. 최종 검증 및 추출 근거
```
[최종 DAG가 모든 기준을 충족하는 이유]
[노드/엣지 선택의 논리적 근거]
```

## 실행 지침
1. 위 7단계 분석 프로세스를 **순서대로** 수행
2. 각 단계에서 발견한 내용을 **명시적으로** 기록
3. DAG 구성 전 **충분한 분석** 수행
4. 초기 DAG 생성 후 **반드시 자기 검증 및 수정** 수행
5. 최종 출력에 **모든 섹션** 포함
6. **중요**: 분석 과정을 생략하지 말고, 사고 과정과 수정 이유를 투명하게 보여주세요

## 예시 분석
### 잘못된 예시 (핵심 흐름만 추출)
```
(에이닷:가입) -[가입후]-> (AI전화서비스:사용)
(AI전화서비스:사용) -[사용하면]-> (네이버페이5000원:수령)
```
→ 문제: 서비스 자체의 가치(AI 기능들)가 누락됨

### 올바른 예시 (완전한 가치 표현 - Root Node 포함)
```
# 매장 방문부터 시작하는 경로
(대리점:방문) -[방문하면]-> (에이닷:가입)
(에이닷:가입) -[가입하면]-> (네이버페이5000원:수령)
(에이닷:가입) -[가입하면]-> (AI통화기능:사용)
(AI통화기능:사용) -[사용하면]-> (통화품질:향상)
(에이닷:가입) -[가입하면]-> (AI스팸필터:사용)
(AI스팸필터:사용) -[사용하면]-> (스팸차단:효과)
```
→ 즉각적 혜택(5000원)과 서비스 가치(AI 기능)를 모두 포함

### 분석 대상 메시지
{message}

위 메시지를 분석하여 7단계 프로세스에 따라 DAG를 추출해주세요.
"""



SIMPLE_DAG_EXTRACTION_PROMPT_TEMPLATE = """
## 작업 목표
통신사 광고 메시지에서 **핵심 행동 흐름**을 추출하여 DAG(Directed Acyclic Graph) 코드로 변환하시오.

## 출력 형식
- 부가 설명 없이 오직 **Code Block** 안에 DAG만 출력할 것.
```

(개체명:기대행동) -[관계동사]-> (개체명:기대행동)

```

## 핵심 추출 규칙
1. **노드 (개체명) 추출 원칙**
    - **필수 추출 대상**
     ㅇ 제품/서비스: 구체적 제품명, 서비스명, 요금제명, 쿠폰, 이벤트, 구독 상품, 프로모션 등
     ㅇ 핵심 혜택: 금전적 혜택, 사은품, 할인, 무료 혜택 등
     ㅇ 행동 장소: 온/오프라인 채널 (필요 시만)

    - **추출 제외 대상**
     ㅇ 광고 대상자 (예: "아이폰 고객님")
     ㅇ 일정/기간 정보
     ㅇ 부가 설명 기능 (핵심 흐름과 무관한 경우)
     ㅇ 법적 고지사항

2. **연결성 원칙 (Connectivity)**: '구매', '가입', '참여' 등의 핵심 행동은 **반드시 Root Node와 연결**되어야 함.
   - ❌ 잘못된 예 (끊어짐):
     `(링크:접속)` ... (연결 없음) ... `(아이폰:구매)`
   - ⭕ 올바른 예 (연결됨):
     `(링크:접속) -[통해]-> (아이폰:구매)`

3. **인과 흐름 구조 (3단계)**:
   - **Step 1 (수단)**: `(링크:접속)` 또는 `(대리점:방문)`
   - **Step 2 (행동)**: `-[통해]->` `(상품:가입)` 또는 `(이벤트:참여)`
   - **Step 3 (결과)**: `-[~하면]->` `(혜택:받다)` 또는 `(효용:경험)`

## 표준 어휘 가이드 (엄수)
- **기대 행동(Action)**: `구매, 가입, 사용, 방문, 참여, 등록, 다운로드, 확인, 수령, 적립, 예약, 신청`
- **관계(Edge)**:
  - `통해` (수단/경로: 링크→행동, 방문→행동)
  - `~하면` (조건: 행동→결과)
  - `받다` (결과: 혜택 획득)

## 예시 분석
### 잘못된 예시 (핵심 흐름만 추출)
```
(에이닷:가입) -[가입후]-> (AI전화서비스:사용)
(AI전화서비스:사용) -[사용하면]-> (네이버페이5000원:수령)
```
→ 문제: 서비스 자체의 가치(AI 기능들)가 누락됨

### 올바른 예시 (완전한 가치 표현 - Root Node 포함)
```
# 매장 방문부터 시작하는 경로
(대리점:방문) -[방문하면]-> (에이닷:가입)
(에이닷:가입) -[가입하면]-> (네이버페이5000원:수령)
(에이닷:가입) -[가입하면]-> (AI통화기능:사용)
(AI통화기능:사용) -[사용하면]-> (통화품질:향상)
(에이닷:가입) -[가입하면]-> (AI스팸필터:사용)
(AI스팸필터:사용) -[사용하면]-> (스팸차단:효과)
```
→ 즉각적 혜택(5000원)과 서비스 가치(AI 기능)를 모두 포함

---
### 분석 대상 메시지
{message}

위 메시지의 핵심 흐름을 DAG로 추출하시오.
"""


def build_dag_extraction_prompt(message: str, mode: str = 'cot') -> str:
    """
    DAG 추출용 프롬프트를 구성합니다.
    
    Args:
        message: 분석할 광고 메시지
        mode: 프롬프트 모드 ('cot', 'full', 'simple'). 기본값은 'cot'.
              - 'cot' 또는 'full': Chain-of-Thought 상세 분석 (DAG_EXTRACTION_PROMPT_TEMPLATE)
              - 'simple': 간단한 분석 (SIMPLE_DAG_EXTRACTION_PROMPT_TEMPLATE)
        
    Returns:
        구성된 DAG 추출 프롬프트
    """
    if mode == 'simple':
        return SIMPLE_DAG_EXTRACTION_PROMPT_TEMPLATE.format(message=message)
    # 'cot' 또는 'full' 모두 상세 분석 프롬프트 사용
    return DAG_EXTRACTION_PROMPT_TEMPLATE.format(message=message)
