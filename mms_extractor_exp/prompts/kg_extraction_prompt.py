"""
Knowledge Graph (KG) Extraction Prompt
=======================================

DAG 프롬프트의 7단계 CoT 분석 구조를 기반으로,
엔티티 역할 분류(prerequisite/offer/benefit/context)와
엔티티 타입·관계를 통합한 KG 추출 프롬프트.

사용되는 곳:
- `services.entity_recognizer`: _extract_entities_stage1() KG 모드
- `core.mms_workflow_steps`: EntityContextExtractionStep에서 사용

출력 형식:
- 분석 과정: 한글 마크다운 (CoT)
- 최종 결과: ```json 블록 (entities, relationships, user_action_path)
"""

KG_EXTRACTION_PROMPT = """
## 작업 목표
통신사 광고 메시지에서 **엔티티, 역할, 관계**를 추출하여 Knowledge Graph를 구성하고,
**핵심 행동 흐름**을 DAG(Directed Acyclic Graph) 형식으로 표현

## 핵심 원칙
1. **Zero-Translation Rule**: 모든 개체명은 원문 그대로 추출
2. **최소 경로 원칙**: 동일한 결과를 얻는 가장 짧은 경로만 표현
3. **핵심 흐름 우선**: 부가적 설명보다 주요 행동 연쇄에 집중
4. **중복 제거**: 의미가 겹치는 노드는 하나로 통합

## 엔티티 역할 분류 (가장 중요)
각 엔티티가 메시지에서 어떤 역할을 하는지 반드시 판별하라:
- `prerequisite`: 타겟 고객이 **이미** 보유/가입/설치한 개체 (MMS 발송 대상 조건)
- `offer`: 메시지가 **새로 제안/안내/유도**하는 핵심 오퍼링
- `benefit`: 고객이 **얻게 되는** 혜택/보상 (금전적 가치, 무료 이용 등)
- `context`: 접점 채널, 캠페인명 등 부가 정보

### prerequisite 판별 신호
- "~이용 안내", "~이용 고객", "~가입 고객", "~설치 고객"
- "~을(를) 이용 중인", "~에 가입한"
- 메시지가 해당 개체의 가입/구매를 유도하지 않고, 이미 보유를 전제로 한다
- 메시지 제목에 "~이용 안내"로 시작하면 해당 개체는 높은 확률로 prerequisite

### ⚠️ prerequisite vs offer 핵심 구분
"안내"가 있다고 무조건 prerequisite가 아니다. **무엇을** 안내하는지가 중요하다:
- "~**이용** 안내" → 이미 보유한 것의 사용법/부가기능 안내 → prerequisite
- "~**무료 이용** 안내", "~**혜택** 안내" → 새로운 사용/혜택을 유도 → **offer** (해당 개체 자체가 아닌 혜택이 핵심)
- "~**구매 혜택** 안내", "~**가입 혜택** 안내" → 구매/가입을 유도 → **offer**
- "~**사전예약** 안내", "~**출시** 안내" → 구매를 유도 → **offer**
- "~**설치** 안내" → 설치를 유도 → **offer**

⚠️ "~이용 안내"에서 prerequisite가 되는 것은 **이미 보유한 상위 서비스/앱**이지,
메시지가 새로 사용을 유도하는 개체는 offer이다.
예: "스마트워치 무료 이용 안내" → 5GX 요금제=prerequisite, 스마트워치=**offer** (새로 연결/사용 유도)

핵심 테스트: **"이 메시지가 해당 개체를 아직 보유하지 않은 고객에게 구매/가입/설치/전환을 유도하는가?"**
→ YES → offer / NO (이미 보유를 전제) → prerequisite

### prerequisite 전이 규칙
prerequisite 구독/번들을 통해 이미 접근이 부여된 서비스도 prerequisite이다.
- "T우주 wavve"=prerequisite → "wavve"도 prerequisite
- 주의: 이름이 유사하더라도 독립적인 상품은 해당하지 않음 (예: "에이닷 전화" ≠ "에이닷")

### offer 판별 신호 (유도 행위 6대 카테고리)
1. **구매/획득**: "~구매하면", "~사전예약", "~출시 기념", "~개통"
2. **가입/구독**: "~가입", "~구독", "~신규가입", "~재가입"
3. **설치/다운로드**: "~설치", "~다운로드", "~앱을 설치해 주세요"
4. **전환/변경**: "~환승", "~기기변경", "~교체", "~변경", "~번호이동"
5. **신청/등록**: "~신청", "~등록", "~응모"
6. **설정/활성화**: "~설정하세요", "~이용해 보세요", "~해 보세요"

### benefit 판별 신호
- "무료", "~원 지원", "~% 할인", "~증정", "캐시백"
- 고객이 offer를 수행하면 얻게 되는 최종 가치

## 엔티티 타입 (Entity Type)
각 엔티티에 아래 타입 중 하나를 부여:
- **Product**: 하드웨어 단말기 (예: "아이폰 17", "갤럭시 Z 폴드7")
- **RatePlan**: 통신 요금제 (예: "5GX 프리미엄", "컴팩트 요금제")
- **Subscription**: 월정액 구독 서비스 (예: "T 우주패스", "보이스피싱 보험")
- **Campaign**: 마케팅 캠페인/프로모션 (예: "9월 0 day", "고객 감사 패키지")
- **Benefit**: 최종 가치/혜택 (예: "20만 원 지원", "이용요금 무료")
- **PartnerBrand**: 제휴 브랜드 (예: "올리브영", "스타벅스")
- **Channel**: 고객 접점 (예: "T 월드 앱", "에이닷 앱")
- **WiredService**: 유선 서비스 (예: "기가인터넷", "B tv")
- **Event**: 일회성 이벤트 (예: "Lucky 1717 추첨")
- **ContentOffer**: 공연/전시/콘텐츠 (예: "뮤지컬 <위대한 개츠비>")
- **Contract**: 약정/지원금 조건 (예: "선택약정 24개월")

## 관계 (Relationship)
엔티티 간 관계를 아래에서 선택:
- `PROMOTES`: 캠페인이 제품/서비스를 홍보
- `OFFERS`: 캠페인이 혜택을 제공
- `INCLUDES`: 구독이 혜택을 포함
- `REQUIRES`: 캠페인이 요금제를 요구
- `ENABLES`: 전제 개체가 오퍼/혜택을 활성화
- `PARTNERS_WITH`: 캠페인이 제휴 브랜드와 협력
- `PROVIDES`: 제휴 브랜드가 혜택을 제공
- `REACHABLE_VIA`: 캠페인이 채널을 통해 접근 가능

## 추출 제외 대상
- **대리점/매장**: main prompt에서 별도 추출 (DAG에도 포함하지 않음)
- 고객센터/연락처, 전화번호
- URL/링크
- 네비게이션 라벨: "바로 가기", "자세히 보기"
- 수신거부 문구: "무료 수신거부 1504"
- 일반 기술 용어 단독: "5G", "LTE"
- 광고 대상자 (예: "아이폰 고객님")
- 일정/기간 정보, 법적 고지사항

## DAG 표현 형식
```
(개체명:기대행동) -[관계동사]-> (개체명:기대행동)
또는
(개체명:기대행동)
```

### 기대 행동 (10개 표준 동사)
`구매, 가입, 사용, 방문, 참여, 등록, 다운로드, 확인, 수령, 적립`

### 관계 동사 우선순위
#### 1순위: 조건부 관계
- `가입하면`, `구매하면`, `사용하면`, `신청하면`, `참여하면`, `다운로드하면`, `전화하면`, `확인하면`, `수령하면`
- `가입후`, `구매후`, `사용후`, `신청후`, `참여후`, `다운로드후`, `전화후`, `확인후`, `수령후`

#### 2순위: 결과 관계
- `받다`, `수령하다`, `적립하다`, `충전하다`, `이용하다`, `사용하다`, `신청하다`, `등록하다`, `다운로드하다`, `확인하다`

#### 3순위: 경로 관계 (필요 시만)
- `통해`, `이용하여`, `사용하여`, `전화하여`, `방문하여`, `참여하여`

## DAG 구성 전략
### Step 1: 모든 가치 제안 식별
광고에서 제시하는 **모든 독립적 가치**를 파악
- **즉각적 혜택**: 금전적 보상, 사은품 등
- **서비스 가치**: 제품/서비스 자체의 기능과 혜택
예: "네이버페이 5000원" + "AI 통화 기능 무료 이용"

### Step 2: 독립 경로 구성
각 가치 제안별로 별도 경로 생성:
1. **혜택 획득 경로**: 가입 → 사용 → 보상
2. **서비스 체험 경로**: 가입 → 경험 → 기능 활용

### Step 3: 세부 기능 표현
주요 기능들이 명시된 경우 분기 구조로 표현:
- 통합 가능한 기능은 하나로 (예: AI통화녹음/요약 → "AI통화기능")
- 독립적 기능은 별도로 (예: AI스팸필터링)

## 분석 프로세스 (필수 7단계)

### Step 1: 메시지 이해
- 전체 메시지를 한 문단으로 요약
- 광고주의 의도 파악
- **타겟 고객 조건**: 이 메시지는 어떤 고객에게 발송되었는가?
- **암시된 행동 식별**: 명시되지 않았지만 필수적인 행동

### Step 2: 가치 제안 식별 + 역할 분류
- **prerequisite**: 타겟 고객이 이미 보유한 상품/서비스
- **offer**: 메시지가 새로 제안하는 것 (유도 행위 6대 카테고리 참조)
- **benefit**: 혜택/보상 (금전, 사은품 등)
- **context**: 채널, 캠페인명 등

### Step 3: Root Node 결정
- **사용자의 첫 번째 행동은 무엇인가?**
- 온라인 링크가 있다면 → 접속이 시작점
- 앱 관련 내용이라면 → 다운로드가 시작점
- **대리점/매장명은 Root Node에서 제외** (main prompt에서 별도 추출)

### Step 4: 관계 분석
- 엔티티 간 관계 파악 (PROMOTES, OFFERS, ENABLES 등)
- Root Node부터 시작하는 전체 흐름
- 각 행동 간 인과관계 검증
- 조건부 관계 명확화

### Step 5: KG + DAG 구성
- 엔티티 목록 (id, type, role)
- 관계 목록 (source, target, type)
- DAG: 독립 경로 구성, 세부 기능 분기
- 중복 제거 및 통합

### Step 6: 자기 검증 및 수정
- **평가**: 아래 기준에 따라 검토
  - prerequisite와 offer가 혼동되지 않았는가?
  - 모든 독립적 가치 제안이 포함되었는가?
  - 엔티티 타입이 올바르게 분류되었는가?
  - Root Node가 명확히 식별되었는가?
  - 관계 동사가 우선순위에 맞게 사용되었는가?
  - 전체 구조가 간결하고 이해하기 쉬운가?
- **문제 식별**: 충족되지 않은 항목을 명시하고, 이유를 설명
- **수정**: 식별된 문제를 해결한 수정 결과 생성

### Step 7: 최종 검증
- 수정된 KG+DAG가 모든 기준을 충족하는지 재확인
- 만약 문제가 남아있다면, 추가 수정 수행 (최대 2회 반복)
- 최종적으로 모든 기준이 충족되었음을 확인

## 출력 형식

분석 과정은 한글 마크다운으로 자유롭게 작성한 후,
**마지막에 반드시 ```json 블록**으로 구조화된 결과를 출력하라.

### 마크다운 분석 (7단계 모두 포함)
```
### 1. 메시지 분석
[메시지 요약 및 핵심 의도]

### 2. 가치 제안 + 역할 분류
[prerequisite / offer / benefit / context 분류]

### 3. Root Node
[Root Node 선택 이유]

### 4. 관계 분석
[엔티티 간 관계 도출]

### 5. 초기 KG + DAG
[초기 구조]

### 6. 자기 검증
[평가 기준별 검토, 문제점 식별, 수정]

### 7. 최종 검증
[최종 확인]
```

### 최종 JSON 출력 (반드시 ```json 블록으로)
```json
{
  "analysis": {
    "message_summary": "메시지 요약 (1-2문장)",
    "target_customer": "타겟 고객 설명",
    "value_proposition": "핵심 가치 제안"
  },
  "entities": [
    {
      "id": "원문명 그대로",
      "type": "엔티티 타입",
      "role": "prerequisite|offer|benefit|context"
    }
  ],
  "relationships": [
    {
      "source": "entity_id",
      "target": "entity_id",
      "type": "관계 타입명"
    }
  ],
  "user_action_path": {
    "dag": "(Node:Action) -[Edge]-> (Node:Action)",
    "logic_summary": "최단 경로 설명"
  }
}
```

## 실행 지침
1. 위 7단계 분석 프로세스를 **순서대로** 수행
2. 각 단계에서 발견한 내용을 **명시적으로** 기록
3. KG + DAG 구성 전 **충분한 분석** 수행
4. 초기 구성 후 **반드시 자기 검증 및 수정** 수행
5. **중요**: 분석 과정을 생략하지 말고, 사고 과정과 수정 이유를 투명하게 보여주세요
6. 마지막에 반드시 ```json 블록을 포함하세요

## 예시 분석

### 잘못된 예시 (역할 분류 오류 + 핵심 흐름만 추출)
```
entities: 에이닷 전화(offer), AI전화서비스(offer), 네이버페이5000원(benefit)
dag: (에이닷전화:가입) -[가입후]-> (AI전화서비스:사용)
     (AI전화서비스:사용) -[사용하면]-> (네이버페이5000원:수령)
```
→ 문제1: "에이닷 전화 이용 안내" → 에이닷 전화는 이미 설치된 앱이므로 prerequisite
→ 문제2: 서비스 자체의 가치(AI 기능들)가 누락됨

### 올바른 예시 (정확한 역할 분류 + 완전한 가치 표현)
```
entities:
  에이닷 전화(Subscription, prerequisite)  ← 이미 설치된 앱 전제
  AI 안심 차단(Subscription, offer)        ← 새로 설정 유도
  AI통화기능(Subscription, offer)          ← 새로 활성화 유도
  네이버페이5000원(Benefit, benefit)       ← 혜택
  AI스팸필터(Subscription, offer)          ← 새로 활성화 유도

relationships:
  에이닷 전화 -(ENABLES)-> AI 안심 차단
  에이닷 전화 -(ENABLES)-> AI통화기능
  에이닷 전화 -(ENABLES)-> AI스팸필터

dag:
  (AI 안심 차단:설정) -[설정하면]-> (네이버페이5000원:수령)
  (AI통화기능:사용) -[사용하면]-> (통화품질:향상)
  (AI스팸필터:사용) -[사용하면]-> (스팸차단:효과)
```
→ prerequisite(에이닷 전화)와 offer(AI 기능들)를 정확히 구분.
→ 즉각적 혜택(5000원)과 서비스 가치(AI 기능)를 모두 포함.
→ 대리점은 DAG에 포함하지 않음.

### 역할 분류 주의 예시 ("~무료 이용 안내" 패턴)
메시지: "스마트워치 무료 이용 안내 ... 5GX 요금제 혜택으로 스마트워치 이용요금 무료"
```
잘못: 스마트워치(Product, prerequisite)  ← "이용 안내"에 이끌려 prerequisite로 오분류
올바름: 5GX 요금제(RatePlan, prerequisite)  ← 이미 가입된 요금제
        스마트워치(Product, offer)           ← 새로 연결/사용을 유도하는 핵심 오퍼
        스마트워치 이용요금 무료(Benefit, benefit)  ← 혜택
```
→ "무료 이용 안내"에서 prerequisite는 혜택을 활성화하는 **요금제**, 스마트워치는 새로 사용을 유도하는 **offer**.

"""
